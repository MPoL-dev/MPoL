

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Parametric Inference with Pyro &#8212; MPoL 0.2.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="https://buttons.github.io/buttons.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'large-tutorials/pyro';</script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Changelog" href="../changelog.html" />
    <link rel="prev" title="Making a Mock Dataset" href="../ci-tutorials/fakedata.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="MPoL 0.2.0 documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="MPoL 0.2.0 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../rml_intro.html">Introduction to Regularized Maximum Likelihood Imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">MPoL Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../units-and-conventions.html">Units and Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-documentation.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/PyTorch.html">Introduction to PyTorch: Tensors and Gradient Descent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/gridder.html">Gridding and diagnostic images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/optimization.html">Intro to RML with MPoL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/loose-visibilities.html">Likelihood functions and model visibilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/crossvalidation.html">Cross validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/gpu_setup.html">GPU Acceleration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/initializedirtyimage.html">Initializing with the Dirty Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="HD143006_part_1.html">HD143006 Tutorial Part 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="HD143006_part_2.html">HD143006 Tutorial Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci-tutorials/fakedata.html">Making a Mock Dataset</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Parametric Inference with Pyro</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/MPoL-dev/MPoL" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/large-tutorials/pyro.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Parametric Inference with Pyro</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mpol-and-models">MPoL and models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-parametric-models">Non-parametric models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parametric-models">Parametric models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dsharp-as-209-dataset">DSHARP AS 209 dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-probabilistic-programming-languages">Introduction to Probabilistic Programming Languages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-parametric-disk-model">Building a parametric disk model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prior-predictive-check">Prior predictive check</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#incorporating-the-data">Incorporating the data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference-with-stochastic-variational-inference-svi">Parameter inference with Stochastic Variational Inference (SVI)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-of-samples">Visualization of samples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#svi-with-a-automultivariatenormal-model">SVI with a AutoMultivariateNormal Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Visualization of samples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference-with-mcmc">Parameter inference with MCMC</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">run</span> notebook_setup
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="parametric-inference-with-pyro">
<h1>Parametric Inference with Pyro<a class="headerlink" href="#parametric-inference-with-pyro" title="Permalink to this heading">#</a></h1>
<p>In all of the tutorials thus far, we have used MPoL to optimize non-parametric image plane models, i.e., collections of pixels. However, there may be instances where the astrophysical source morphology is simple enough at the resolution of the data such that an investigator might wish to fit a parametric model to the data. In the protoplanetary disk field, there is a long history of parametric model fits to data. The simplest example of this would be an elliptical Gaussian fit through CASA’s <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/tt/casatasks.manipulation.uvmodelfit.html">uvmodelfit</a>, while a more complex example might be the <a class="reference external" href="https://mtazzari.github.io/galario/">Galario</a> package. While non-parametric models tend to get all of the attention in this era of Big Data, well-constructed parametric models can still prove useful thanks to their interpretability and role in Bayesian inference.</p>
<p>In this tutorial, we will explore how we can use MPoL with a probabilistic programming language called <a class="reference external" href="https://pyro.ai/">Pyro</a> to perform parametric model fitting with a continuum protoplanetary disk dataset and derive posterior probability distributions of the model parameters. One major advantage of using MPoL + Pyro to do parametric model fitting compared to existing packages is that posterior gradient information is naturally provided by PyTorch’s autodifferentiation capabilities. This, coupled with the industry-grade inference algorithms provided by Pyro, makes it computationally efficient to explore posterior probability distributions with dozens or even hundreds of parameters–something that would be impractical using classical MCMC algorithms.</p>
<p>In this tutorial, we will use <a class="reference external" href="http://pyro.ai/examples/svi_part_i.html">Stochastic Variational Inference</a> algorithms to obtain the posterior distribution of the model parameters. These algorithms are quick to implement in Pyro and–important for this tutorial–quick to run. Pyro also has full support for MCMC algorithms like Hamiltonian Monte Carlo and the No U-Turn Sampler (NUTS) (<a class="reference external" href="http://pyro.ai/examples/bayesian_regression_ii.html#HMC">for example</a>) that are relatively straightforward to use in an extension from this model. However, because their run times are significantly longer than SVI algorithms, more computational resources are needed beyond the scope of this tutorial.</p>
<p>If the following output says <code class="docutils literal notranslate"><span class="pre">Using</span> <span class="pre">cuda</span></code>, then this tutorial was executed on a GPU. We found that it took about 5 minutes to converge the SVI, which is pretty exciting. You may be able to run this on CPU-only machine, but expect the runtime to take significantly longer. You may want to shorten the number of iterations and reduce the number of predictive samples to get a sense that the routine will in fact execute, but be aware that your solution may not fully converge.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>                   
<span class="k">else</span><span class="p">:</span>                                                       
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>   

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>    
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using cuda.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import arviz now, to check UTF-8 loading issue.</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
</pre></div>
</div>
</div>
</div>
<section id="mpol-and-models">
<h2>MPoL and models<a class="headerlink" href="#mpol-and-models" title="Permalink to this heading">#</a></h2>
<p>Before we discuss the specifics of the parametric disk model, let’s take a high-level look at what makes up an MPoL model.</p>
<section id="non-parametric-models">
<h3>Non-parametric models<a class="headerlink" href="#non-parametric-models" title="Permalink to this heading">#</a></h3>
<p>Let’s start by considering the architecture of the simplest possible skeleton non-parametric RML model</p>
<div class="mermaid">
            graph TD
ic(ImageCube) --&gt; FourierLayer
FourierLayer --&gt; il([Loss])
ad[[Dataset]] --&gt; il([Loss])

        </div><p>When we say that a model is non-parametric we generally mean that the number of parameters of the model is vast (potentially infinite) and can grow to encapsulate more detail if needed. A classic example is something like a spline or a Gaussian process, but in our case we are using a large number of discrete pixel fluxes to represent an image.</p>
<p>We can see the definition of these “non-parametric” image parameters in the Pytorch layer</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">cube</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">npix</span><span class="p">),</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">nn.Parameter</span></code> call tells Pytorch that the <code class="docutils literal notranslate"><span class="pre">cube</span></code> tensor containing the image pixels should be varied during optimization.</p>
<p>We can consider the architecture of the <a class="reference internal" href="../api.html#mpol.precomposed.SimpleNet" title="mpol.precomposed.SimpleNet"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.precomposed.SimpleNet</span></code></a> as a more practical extension</p>
<div class="mermaid">
            graph TD
    subgraph SimpleNet
    bc(BaseCube) --&gt; HannConvCube
    HannConvCube --&gt; ImageCube
    ImageCube --&gt; FourierLayer
    end
    FourierLayer --&gt; il([Loss])
    ad[[Dataset]] --&gt; il([Loss])

        </div><p>The functionality of the <a class="reference internal" href="../api.html#mpol.precomposed.SimpleNet" title="mpol.precomposed.SimpleNet"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.precomposed.SimpleNet</span></code></a> is similar to the skeleton model, but we’ve shifted the base parameterization from the <a class="reference internal" href="../api.html#mpol.images.ImageCube" title="mpol.images.ImageCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.images.ImageCube</span></code></a> to the <a class="reference internal" href="../api.html#mpol.images.BaseCube" title="mpol.images.BaseCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.images.BaseCube</span></code></a> (so that pixel flux values are non-negative) and we’ve included a small convolution kernel (through <a class="reference internal" href="../api.html#mpol.images.HannConvCube" title="mpol.images.HannConvCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.images.HannConvCube</span></code></a>) so that high-spatial-frequency noise is suppressed. In this framework, the <code class="docutils literal notranslate"><span class="pre">nn.Parameter</span></code>s are instantiated on the <a class="reference internal" href="../api.html#mpol.images.BaseCube" title="mpol.images.BaseCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseCube</span></code></a> and the <a class="reference internal" href="../api.html#mpol.images.ImageCube" title="mpol.images.ImageCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">ImageCube</span></code></a> becomes a pass-through layer.</p>
<p>In both of these cases, the key functionality provided by the MPoL package is the <a class="reference internal" href="../api.html#mpol.fourier.FourierCube" title="mpol.fourier.FourierCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.fourier.FourierCube</span></code></a> layer that translates a model image into the visibility plane. From the perspective of the <a class="reference internal" href="../api.html#mpol.fourier.FourierCube" title="mpol.fourier.FourierCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">FourierCube</span></code></a>, it doesn’t care how the model image was produced, it will happily translate image pixels into visibility values using the FFT.</p>
</section>
<section id="parametric-models">
<h3>Parametric models<a class="headerlink" href="#parametric-models" title="Permalink to this heading">#</a></h3>
<p>By contrast to a non-parametric model, a <em>parametric</em> model is one that has a (finite) set of parameters (generally decoupled from the size of the data) and can be easily used to make future predictions of the data, usually in a functional form. For example, a cubic function and its coefficients would be considered a parametric model. For a radio astronomy example, you can think of the <a class="reference internal" href="../api.html#mpol.images.BaseCube" title="mpol.images.BaseCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseCube</span></code></a> and <a class="reference internal" href="../api.html#mpol.images.HannConvCube" title="mpol.images.HannConvCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.images.HannConvCube</span></code></a> layers as being replaced by a parametric disk model, which we’ll call <code class="docutils literal notranslate"><span class="pre">DiskModel</span></code>. This parametric model would specify pixel brightness as a function of position based upon model parameters, and would feed directly into the <a class="reference internal" href="../api.html#mpol.images.ImageCube" title="mpol.images.ImageCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">ImageCube</span></code></a> pass-through layer.</p>
<div class="mermaid">
            graph TD
pm(DiskModel) --&gt; ImageCube
ImageCube --&gt; FourierLayer
FourierLayer --&gt; il([Loss])
ad[[Dataset]] --&gt; il([Loss])

        </div><p>Before ALMA, it was common in the protoplanetary disk field to fit parametric models (e.g., elliptical Gaussians, one or two axisymmetric rings, etc…) to interferometric observations to derive source properties like size and inclination. The spatial resolution afforded by the ALMA long-baseline campaign rendered many of these simple parametric models inadequate. Suddenly, rich substructure in the forms of rings, gaps, and spirals was visible in dust continuum images and, except for a few exceptions we’ll discuss in a second, these morphologies were too complex to neatly capture with simple model parameterizations.</p>
<p>This spurred a major shift from parametric, visibility-based analyses to image-based analysis (including our own MPoL efforts). Visibility-based analysis is still viable, but with modern datasets it must often be more sophisticated. For example, non-parametric 1D models like <a class="reference external" href="https://discsim.github.io/frank/">frank</a> are capable of super-resolution compared to image-based methods like CLEAN for axisymmetric sources.</p>
<p>In our opinion, the two (linked) reasons that parametric model fitting has fallen out of favor in the protoplanetary disk field are</p>
<ol class="arabic simple">
<li><p>ALMA data are sufficiently high quality that many model parameters are required to accurately describe disk emission</p></li>
<li><p>standard sampling algorithms used for Bayesian inference do not perform well in high dimensional parameter spaces</p></li>
</ol>
<p>As we hinted at, the MPoL + Pyro + PyTorch framework will help us out on point #2, such that we might be able to explore more detailed models with larger numbers of parameters.</p>
<p>The point of this tutorial isn’t to say that everyone should switch back to using parametric models. But rather that with the industry-grade machinery of probabilistic programming languages and autodifferentiation, there may be situations where parametric models are still useful.</p>
</section>
</section>
<section id="dsharp-as-209-dataset">
<h2>DSHARP AS 209 dataset<a class="headerlink" href="#dsharp-as-209-dataset" title="Permalink to this heading">#</a></h2>
<p>For this tutorial we’ll use the ALMA DSHARP dust continuum observations of the AS 209 protoplanetary disk. The data reduction is described in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..41A/abstract">Andrews et al. 2018</a> and the primary analysis is described in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..48G/abstract">Guzmán et al. 2018</a>.</p>
<p>The original measurement sets from the DSHARP program are available in measurement set format from the ALMA project pages (e.g., <a class="reference external" href="https://bulk.cv.nrao.edu/almadata/lp/DSHARP/">NRAO</a>). To save some boilerplate code and computation time for the purposes of this tutorial, we have extracted the visibilities from this measurement set, performed a few averaging and weight scaling steps, and uploaded the processed dataset to a Zenodo <a class="reference external" href="https://zenodo.org/record/7732834#.ZBCKAexKhhE">repository</a> as an <a class="reference external" href="https://asdf.readthedocs.io/en/stable/index.html">asdf</a> file. The full set of pre-processing commands are available in the <a class="reference external" href="https://github.com/MPoL-dev/mpoldatasets/tree/main/products/AS209-DSHARP-continuum-averaged">mpoldatasets package</a>. Let’s download the file and extract the visibilities</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>

<span class="n">fname</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
    <span class="s2">&quot;https://zenodo.org/record/7732834/files/AS209_continuum_averaged.asdf&quot;</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">pkgname</span><span class="o">=</span><span class="s2">&quot;mpol&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asdf</span> 

<span class="c1"># load extracted visibilities from asdf file </span>
<span class="n">d</span> <span class="o">=</span> <span class="n">asdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
<span class="n">uu</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;uu&quot;</span><span class="p">]</span>
<span class="n">vv</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;vv&quot;</span><span class="p">]</span>
<span class="n">weight</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>    
</pre></div>
</div>
</div>
</div>
<p>Let’s use the MPoL <a class="reference internal" href="../api.html#mpol.gridding.DirtyImager" title="mpol.gridding.DirtyImager"><code class="xref py py-class docutils literal notranslate"><span class="pre">DirtyImager</span></code></a> to make some diagnostic images, to make sure we’ve loaded the data correctly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span> 
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>

<span class="kn">from</span> <span class="nn">mpol</span> <span class="kn">import</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">gridding</span>

<span class="c1"># settle on an image size that we&#39;ll use throughout the tutorial</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">GridCoords</span><span class="p">(</span><span class="n">cell_size</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
<span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;interpolation&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;extent&quot;</span><span class="p">:</span> <span class="n">coords</span><span class="o">.</span><span class="n">img_ext</span><span class="p">,</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span><span class="s2">&quot;inferno&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">make_dirty_image</span><span class="p">(</span><span class="n">data_real</span><span class="p">,</span> <span class="n">data_imag</span><span class="p">,</span> <span class="n">robust</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a plot of the dirty beam and dirty image (in units of Jy/arcsec^2).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data_real (numpy array): real components of visibilities</span>
<span class="sd">        data_imag (numpy array): imaginary components of visibilities</span>
<span class="sd">        robust (float): the Briggs robust parameter</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        beam, image numpy arrays</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">imager</span> <span class="o">=</span> <span class="n">gridding</span><span class="o">.</span><span class="n">DirtyImager</span><span class="p">(</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
        <span class="n">uu</span><span class="o">=</span><span class="n">uu</span><span class="p">,</span>
        <span class="n">vv</span><span class="o">=</span><span class="n">vv</span><span class="p">,</span>
        <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
        <span class="n">data_re</span><span class="o">=</span><span class="n">data_real</span><span class="p">,</span>
        <span class="n">data_im</span><span class="o">=</span><span class="n">data_imag</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">imager</span><span class="o">.</span><span class="n">get_dirty_image</span><span class="p">(</span><span class="n">weighting</span><span class="o">=</span><span class="s2">&quot;briggs&quot;</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;Jy/arcsec^2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img</span><span class="p">,</span> <span class="n">beam</span> <span class="o">=</span> <span class="n">make_dirty_image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="c1"># set plot dimensions</span>
<span class="n">xx</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># in</span>
<span class="n">cax_width</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># in </span>
<span class="n">cax_sep</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># in</span>
<span class="n">mmargin</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">lmargin</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">rmargin</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">tmargin</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">bmargin</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">npanels</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># the size of image axes + cax_sep + cax_width</span>
<span class="n">block_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">lmargin</span> <span class="o">-</span> <span class="n">rmargin</span> <span class="o">-</span> <span class="n">mmargin</span> <span class="o">*</span> <span class="p">(</span><span class="n">npanels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="n">npanels</span>
<span class="n">ax_width</span> <span class="o">=</span> <span class="n">block_width</span> <span class="o">-</span> <span class="n">cax_width</span> <span class="o">-</span> <span class="n">cax_sep</span>
<span class="n">ax_height</span> <span class="o">=</span> <span class="n">ax_width</span> 
<span class="n">yy</span> <span class="o">=</span> <span class="n">bmargin</span> <span class="o">+</span> <span class="n">ax_height</span> <span class="o">+</span> <span class="n">tmargin</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cax</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npanels</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([(</span><span class="n">lmargin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">block_width</span> <span class="o">+</span> <span class="n">mmargin</span><span class="p">))</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="n">bmargin</span><span class="o">/</span><span class="n">yy</span><span class="p">,</span> <span class="n">ax_width</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="n">ax_height</span><span class="o">/</span><span class="n">yy</span><span class="p">]))</span>
    <span class="n">cax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([(</span><span class="n">lmargin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">block_width</span> <span class="o">+</span> <span class="n">mmargin</span><span class="p">)</span> <span class="o">+</span> <span class="n">ax_width</span> <span class="o">+</span> <span class="n">cax_sep</span><span class="p">)</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="n">bmargin</span><span class="o">/</span><span class="n">yy</span><span class="p">,</span> <span class="n">cax_width</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="n">ax_height</span><span class="o">/</span><span class="n">yy</span><span class="p">]))</span>

<span class="c1"># single-channel image cube    </span>
<span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">im_beam</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">beam</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_beam</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;beam&quot;</span><span class="p">)</span>
<span class="c1"># zoom in a bit</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;dirty image&quot;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Jy/$\mathrm</span><span class="si">{arcsec}</span><span class="s2">^2$&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta \alpha \cos \delta$ [$</span><span class="si">{}</span><span class="s2">^{\prime\prime}$]&quot;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta \delta$ [$</span><span class="si">{}</span><span class="s2">^{\prime\prime}$]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3db07d740b9ed2d742ee5951d635d4a58332ee4fa1409a486430d8316cdb5795.png" src="../_images/3db07d740b9ed2d742ee5951d635d4a58332ee4fa1409a486430d8316cdb5795.png" />
</div>
</div>
<p>In their DSHARP paper, Guzmán et al. 2018 noted the striking azimuthal symmetry of the AS 209 disk. This motivated them to develop and fit a 1D surface brightness profile <span class="math notranslate nohighlight">\(I(r)\)</span> using a series of concentric Gaussian rings of the form</p>
<div class="math notranslate nohighlight">
\[
I(r) = \sum_{i=0}^N A_i \exp \left (- \frac{(r - r_i)^2}{2 \sigma_i^2} \right).
\]</div>
<p>The axisymmetry of the model allowed them to use the Hankel transform to compute the visibility function <span class="math notranslate nohighlight">\(\mathcal{V}\)</span> corresponding to a given <span class="math notranslate nohighlight">\(I(r)\)</span>. The Hankel transform also plays a key role in non-parametric 1D methods like  <a class="reference external" href="https://discsim.github.io/frank/">frank</a>. Guzmán et al. 2018 evaluated the probability of the data given the model visibilities using a likelihood function and assigned prior probability distributions to their model parameters. They used the <a class="reference external" href="https://emcee.readthedocs.io/">emcee</a> MCMC ensemble sampler to sample the posterior distribution of the parameters and thus infer the surface brightness profile <span class="math notranslate nohighlight">\(I(r)\)</span>.</p>
<p>In what follows we will use Pyro and the MPoL framework to implement the same concentric Gaussian ring model as Guzmán et al. 2018 and (hopefully) verify that we obtain the same result. But, we should note that because MPoL uses the 2D FFT to perform the Fourier Transform, we do not need to assume an axisymmetric model. This may be beneficial when fitting disk morphologies that are not purely axisymmetric.</p>
</section>
<section id="introduction-to-probabilistic-programming-languages">
<h2>Introduction to Probabilistic Programming Languages<a class="headerlink" href="#introduction-to-probabilistic-programming-languages" title="Permalink to this heading">#</a></h2>
<p>Many astronomers usually follow an MCMC analysis pathway similar to Guzmán et al. 2018: they write custom code to implement their model, calculate their likelihood function and priors, and then use an MCMC package like <code class="docutils literal notranslate"><span class="pre">emcee</span></code> to sample the posterior.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Probabilistic_programming">Probabilistic programming languages</a> (PPLs)
are by no means a recent invention, but have in recent years become much more powerful and scientifically capable thanks to the integration of autodifferentiation and advanced sampling methodologies that use gradient information. In our own subfield, we are most familiar with the <a class="reference external" href="https://docs.exoplanet.codes/en/latest/">exoplanet</a> codebase, built on PyMC3; however, a quick search on ADS demonstrates that probabilistic programming languages have seen greater usage by astronomers in the past decade across a variety of subfields.</p>
<p>Simply put, PPLs are frameworks that help users build statistical models and then infer/optimize the parameters of those models conditional on some dataset. PPLs usually have their own learning curve that requires familiarizing oneself with the syntax of the language and the mechanics of building models; once the learning curve is climbed, however, PPLs have the potential to be incredibly powerful inference tools.</p>
<p><a class="reference external" href="https://pyro.ai/">Pyro</a> is the main PPL built on PyTorch, so that is what we will use in this tutorial. In what follows we’ll try to explain the relevant parts of Pyro that you’ll need to get started, but a full introduction to Pyro and PPLs is beyond the scope of this tutorial. If you are interested, we recommend you see the following resources:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://pyro.ai/examples/intro_long.html">Introduction to Pyro</a></p></li>
<li><p><a class="reference external" href="http://pyro.ai/examples/bayesian_regression.html">Bayesian Regression - Introduction</a></p></li>
</ul>
<p>The Pyro <a class="reference external" href="http://pyro.ai/examples/index.html">examples</a> page and <a class="reference external" href="https://docs.pyro.ai/en/stable/">documentation</a> have much more information that can help you get started.</p>
<aside class="margin sidebar">
<p class="sidebar-title">New to Bayes</p>
<p>If you are new to Bayesian analysis in general, we recommend that you put this tutorial aside for a moment and review some introductory resources like <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2023arXiv230204703E/abstract">Eadie et al. 2023</a> and references therein.</p>
</aside>
<p>We also recommend reading Gelman et al. 2020’s paper on <a class="reference external" href="https://arxiv.org/abs/2011.01808">Bayesian Workflow</a>. It contains very useful advice on structuring a large and complex Bayesian data analysis problem and will no doubt save you time when constructing your own models.</p>
</section>
<section id="building-a-parametric-disk-model">
<h2>Building a parametric disk model<a class="headerlink" href="#building-a-parametric-disk-model" title="Permalink to this heading">#</a></h2>
<p>There are many ways to build a Pyro model. In this tutorial we will take a class-based approach and use the <a class="reference external" href="http://pyro.ai/examples/modules.html">PyroModule</a> construct, but models can just as easily be built using function definitions (for <a class="reference external" href="http://pyro.ai/examples/intro_long.html#Models-in-Pyro">example</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">mpol</span> <span class="kn">import</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">gridding</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">fourier</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">mpol.constants</span> <span class="kn">import</span> <span class="n">deg</span>

<span class="kn">import</span> <span class="nn">pyro</span>
<span class="kn">import</span> <span class="nn">pyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">from</span> <span class="nn">pyro.nn</span> <span class="kn">import</span> <span class="n">PyroModule</span><span class="p">,</span> <span class="n">PyroParam</span><span class="p">,</span> <span class="n">PyroSample</span><span class="p">,</span> <span class="n">pyro_method</span>
</pre></div>
</div>
</div>
</div>
<p>First, we’ll define a class that we’ll call <code class="docutils literal notranslate"><span class="pre">PyroDisk</span></code>. This class defines Guzmán et al. 2018’s ringed model using the Pyro PPL and produces an image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PyroDisk</span><span class="p">(</span><span class="n">PyroModule</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This routine returns an image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nchan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">nchan</span>

        <span class="c1"># observer-frame coordinates</span>
        <span class="n">YY</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">packed_x_centers_2D</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">XX</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">packed_y_centers_2D</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;YY&quot;</span><span class="p">,</span> <span class="n">YY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;XX&quot;</span><span class="p">,</span> <span class="n">XX</span><span class="p">)</span>
        <span class="c1"># This mashup is because of the way we define the coordinate system for orbital elements.</span>
        <span class="c1"># YY points north</span>
        <span class="c1"># XX points east</span>

        <span class="c1"># setup geometric parameters</span>

        <span class="c1"># the model is axisymmetric, so argument of periastron is degenerate. We set this to 0 and </span>
        <span class="c1"># do not sample in it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="mi">0</span> 

        <span class="c1"># we have a reasonably good guess as to these orientations from inspection of the </span>
        <span class="c1"># dirty image and so Normal priors are fine. </span>
        <span class="c1"># If we were very uncertain about these parameters, it might make sense using </span>
        <span class="c1"># the Von Mises distribution for the angles like omega, incl, and Omega</span>
        <span class="c1"># https://docs.pyro.ai/en/stable/distributions.html?highlight=constraints#vonmises</span>
        <span class="c1"># https://en.wikipedia.org/wiki/Von_Mises_distribution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incl</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">35.</span> <span class="o">*</span> <span class="n">deg</span><span class="p">,</span> <span class="mf">5.</span> <span class="o">*</span> <span class="n">deg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Omega</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">85.0</span> <span class="o">*</span> <span class="n">deg</span><span class="p">,</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">deg</span><span class="p">))</span>
        
        <span class="c1"># to treat parameters as fixed, simply assign them as torch tensors</span>
        <span class="c1"># for example,</span>
        <span class="c1"># self.x_centroid = torch.as_tensor(x_centroid)  # arcsec</span>
        <span class="c1"># self.y_centroid = torch.as_tensor(y_centroid)  # arcsec</span>

        <span class="c1"># otherwise, define latent random variables using PyroSample</span>
        <span class="c1"># and a distribution object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_centroid</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3e-3</span><span class="p">))</span> <span class="c1"># arcsec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_centroid</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3e-3</span><span class="p">))</span> <span class="c1"># arcsec</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>  <span class="c1"># pc</span>

        <span class="c1"># Define a 1D radial grid for evaluating the 1D intensity profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">])),</span> <span class="n">steps</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span>

       <span class="c1"># central Gaussian envelope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_A_0</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_sigma_0</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
    
        <span class="c1"># list of Gaussian parameters</span>
        <span class="c1"># ring means from Huang et al. 2018a.</span>
        <span class="n">ring_means</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">14.</span><span class="p">,</span> <span class="mf">28.</span><span class="p">,</span> <span class="mf">41.</span><span class="p">,</span> <span class="mf">74.</span><span class="p">,</span> <span class="mf">99.</span><span class="p">,</span> <span class="mf">120.</span><span class="p">,</span> <span class="mf">141.</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ring_means</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_ring_sigmas</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nrings</span><span class="p">])</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_ring_amplitudes</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nrings</span><span class="p">])</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># we set the mean of the Normal prior on the ring means to the values from Huang</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ring_means</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">ring_means</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            

    <span class="nd">@pyro_method</span>
    <span class="k">def</span> <span class="nf">_Gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">A_i</span><span class="p">,</span> <span class="n">r_i</span><span class="p">,</span> <span class="n">sigma_i</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate a Gaussian ring of the form</span>

<span class="sd">        .. math::</span>

<span class="sd">            f(r) = A_i \exp \left(- \frac{(r - r_i)^2}{2 \sigma_i^2} \right)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">A_i</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">r_i</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">sigma_i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@pyro_method</span>
    <span class="k">def</span> <span class="nf">intensity_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the intensity profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># evaluate the central Gaussian</span>
        <span class="n">A_0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_A_0</span><span class="p">)</span>
        <span class="n">r_0</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">sigma_0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_sigma_0</span><span class="p">)</span>

        <span class="n">I</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Gaussian</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">A_0</span><span class="p">,</span> <span class="n">r_0</span><span class="p">,</span> <span class="n">sigma_0</span><span class="p">)</span>

        <span class="c1"># evaluate the rings</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrings</span><span class="p">):</span>
            <span class="n">A_i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_ring_amplitudes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">r_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ring_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sigma_i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_ring_sigmas</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">I</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Gaussian</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">A_i</span><span class="p">,</span> <span class="n">r_i</span><span class="p">,</span> <span class="n">sigma_i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">I</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># take 2D coords object and project it to 2D frame</span>
        <span class="c1"># units of arcseconds</span>
        <span class="n">x_warped</span><span class="p">,</span> <span class="n">y_warped</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">observer_to_flat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">YY</span><span class="p">,</span> <span class="n">omega</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">incl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">incl</span><span class="p">,</span> <span class="n">Omega</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Omega</span>
        <span class="p">)</span>

        <span class="c1"># apply centroid offset</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">x_warped</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_centroid</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">y_warped</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_centroid</span>

        <span class="c1"># convert x,y to radial coordinates and then to AU</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span>  <span class="c1"># [AU]</span>

        <span class="c1"># evaluate the 2D images against the profile</span>
        <span class="c1"># to create an image cube</span>
        <span class="n">II</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intensity_profile</span><span class="p">(</span><span class="n">rr</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># store deterministic variables for later predictive tests</span>
        <span class="c1"># 1D profiles </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iprofile1D</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;iprofile1D&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">))</span>

        <span class="c1"># 2D images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky_cube</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
            <span class="s2">&quot;sky_cube&quot;</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">packed_cube_to_sky_cube</span><span class="p">(</span><span class="n">II</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># convert from Jy/arcsec^2 to Jy/pixel by multiplying by cell_size^2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_flux</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
            <span class="s2">&quot;total_flux&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">cell_size</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">II</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># packed image with extra channel dimension</span>
        <span class="k">return</span> <span class="n">II</span>
</pre></div>
</div>
</div>
</div>
<p>We’ve gone ahead and defined many of our model parameters as latent random variables using <code class="docutils literal notranslate"><span class="pre">PyroSample</span></code>. The prior distribution on these parameters is defined by the <code class="docutils literal notranslate"><span class="pre">dist...</span></code>. For example, with the</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">log_A_0</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
</pre></div>
</div>
<p>line we’ve defined the prior on the <code class="docutils literal notranslate"><span class="pre">log_A_0</span></code> parameter to be a Normal distribution with mean <span class="math notranslate nohighlight">\(\mu = 0.0\)</span> and standard deviation of <span class="math notranslate nohighlight">\(\sigma = 0.3\)</span>.</p>
<p>We have also used multivariate parameters to describe the features of the rings. For example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">log_ring_sigmas</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span>
    <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nrings</span><span class="p">])</span><span class="o">.</span><span class="n">to_event</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>has set the prior distribution on each of the (logarithm of the) ring widths to be a Normal distribution with mean of <span class="math notranslate nohighlight">\(\mu=0.8\)</span> and standard deviation of <span class="math notranslate nohighlight">\(\sigma=0.3\)</span>. Not including the central Gaussian envelope, we have 7 rings in this model. The <code class="docutils literal notranslate"><span class="pre">.expand()</span></code> call turns a Normal distribution with a shape of <code class="docutils literal notranslate"><span class="pre">1</span></code> into a distribution with a <em>batch</em> shape of 7. This isn’t quite what we want in this application, so the <code class="docutils literal notranslate"><span class="pre">to_event()</span></code> call converts the <em>batch</em> shape into the <em>event</em> shape. For more details on Pyro tensor shapes, we recommend reading the <a class="reference external" href="https://pyro.ai/examples/tensor_shapes.html">Tensor shapes in Pyro tutorial</a>.</p>
<p>When building a new model, we recommend starting out by introducing a set of latent random variables with <code class="docutils literal notranslate"><span class="pre">PyroSample</span></code> and fixing most parameters (by simply defining them as torch tensors, as noted in the comments in the above code).</p>
<section id="prior-predictive-check">
<h3>Prior predictive check<a class="headerlink" href="#prior-predictive-check" title="Permalink to this heading">#</a></h3>
<p>Following the advice in <a class="reference external" href="https://arxiv.org/abs/2011.01808">Bayesian Workflow</a>, we’ll first test out this model using a <em>prior predictive check</em>. This is where we generate random samples from each of the prior distributions and use them to produce versions of the model, in this case, random images of disks with 7 rings. This step is very useful because it helps you identify obvious implementation errors with your model. For example, one design flaw we spotted with an earlier iteration of our code was when we used Normal priors on the ring amplitudes and widths. Both of these values should be positive-valued, which motivated our shift to using Normal priors on the logarithm of the ring amplitudes and widths.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># parameters from Guzman     </span>
<span class="n">distance</span> <span class="o">=</span> <span class="mf">121.0</span>  <span class="c1"># pc</span>

<span class="c1"># initialize the model </span>
<span class="n">image_model</span> <span class="o">=</span> <span class="n">PyroDisk</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To generate samples from the prior we’ll use Pyro’s <a class="reference external" href="https://docs.pyro.ai/en/stable/inference_algos.html#module-pyro.infer.predictive">predictive</a> tool</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyro.infer</span> <span class="kn">import</span> <span class="n">Predictive</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize a Predictive object, do not condition on any posterior_samples</span>
<span class="n">prior_predictive</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">image_model</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># call the object to get prior predictive samples</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">prior_predictive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s examine the dictionary of output</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;incl&#39;, &#39;Omega&#39;, &#39;x_centroid&#39;, &#39;y_centroid&#39;, &#39;log_A_0&#39;, &#39;log_sigma_0&#39;, &#39;log_ring_amplitudes&#39;, &#39;ring_means&#39;, &#39;log_ring_sigmas&#39;, &#39;iprofile1D&#39;, &#39;sky_cube&#39;, &#39;total_flux&#39;])
</pre></div>
</div>
</div>
</div>
<p>We see that we now have a dictionary with a list of 10 random samples from the prior. We have the latent random variables that we specified, but we also have the deterministic variables like the 1D profile, total flux, and sky cube. Let’s plot up 4 of these sky cubes to get a sense of what we’re dealing with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;sky_cube&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">chan</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">coords</span><span class="o">.</span><span class="n">img_ext</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c52a7f59e21faec80cb945908c6633daa30f5f19e70debecc7abbd2f34395abc.png" src="../_images/c52a7f59e21faec80cb945908c6633daa30f5f19e70debecc7abbd2f34395abc.png" />
</div>
</div>
<p>And we can visualize the 1D profiles</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;iprofile1D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([10, 400])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;iprofile1D&quot;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">image_model</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.2&quot;</span><span class="p">)</span>
    
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;radius [au]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$I_\nu$ [Jy $\mathrm</span><span class="si">{arcsec}</span><span class="s2">^{-2}$]&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1104133dc6dd738efc62e2e236e5e8fb665002e61bd7280a0c44b0f423323089.png" src="../_images/1104133dc6dd738efc62e2e236e5e8fb665002e61bd7280a0c44b0f423323089.png" />
</div>
</div>
<p>Obviously these do not look exactly like the actual AS 209 disk, and that’s OK! These are just samples from the prior distribution; the model hasn’t touched any data yet. What is reassuring is that the posterior predictions look like <em>plausible</em> disks. For example, they are in roughly the center of the field, there are no negative flux values, inclination and position angle <span class="math notranslate nohighlight">\(\Omega\)</span> behave as they should, etc.</p>
<p>Before we move on, though, it would be good to check that we can reproduce a disk that does look like the AS 209 disk using the posterior distributions inferred by Guzmán et al. 2018. To do this we’ll use <code class="docutils literal notranslate"><span class="pre">Predictive</span></code> conditioned on a “sample” from the posterior. In reality, we’ll just take the maximum a posteriori (MAP) values reported by Guzmán et al. 2018 and treat this as a single sample. Samples are generally reported from the <code class="docutils literal notranslate"><span class="pre">Predictive</span></code> routine as a dictionary of PyTorch tensor arrays, each with length <code class="docutils literal notranslate"><span class="pre">nsamples</span></code>. So we’ll need to mimic this structure when providing the Guzmán values to the <code class="docutils literal notranslate"><span class="pre">posterior_samples</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guzman_values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_centroid&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.70e-3</span><span class="p">]),</span>
                <span class="s1">&#39;y_centroid&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">3.1e-3</span><span class="p">]),</span>
                <span class="s1">&#39;log_A_0&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])),</span>
                <span class="s1">&#39;log_sigma_0&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">6.69</span><span class="p">])),</span> 
                <span class="s1">&#39;log_ring_amplitudes&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.274</span><span class="p">,</span> <span class="mf">0.133</span><span class="p">,</span> <span class="mf">0.115</span><span class="p">,</span> <span class="mf">0.074</span><span class="p">,</span> <span class="mf">0.004</span><span class="p">,</span> <span class="mf">0.051</span><span class="p">,</span> <span class="mf">0.008</span><span class="p">]]))),</span> 
                <span class="s1">&#39;ring_means&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">15.13</span><span class="p">,</span> <span class="mf">27.07</span><span class="p">,</span> <span class="mf">41.42</span><span class="p">,</span> <span class="mf">74.08</span><span class="p">,</span> <span class="mf">91.76</span><span class="p">,</span> <span class="mf">120.42</span><span class="p">,</span> <span class="mf">139.06</span><span class="p">]])),</span> 
                <span class="s1">&#39;log_ring_sigmas&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">7.41</span><span class="p">,</span> <span class="mf">11.72</span><span class="p">,</span> <span class="mf">17.40</span><span class="p">,</span> <span class="mf">7.34</span><span class="p">,</span> <span class="mf">23.39</span><span class="p">,</span> <span class="mf">9.84</span><span class="p">,</span> <span class="mf">23.10</span><span class="p">]]))),</span>
                 <span class="s1">&#39;incl&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">34.88</span> <span class="o">*</span> <span class="n">deg</span><span class="p">]),</span>
                 <span class="s1">&#39;Omega&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">85.764</span> <span class="o">*</span> <span class="n">deg</span><span class="p">]),</span>
               <span class="p">}</span>

<span class="c1"># initialize a Predictive object, condition on the Guzman &quot;posterior sample&quot;</span>
<span class="n">prior_predictive_conditional</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">image_model</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">guzman_values</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">prior_predictive_conditional</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;sky_cube&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">chan</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">coords</span><span class="o">.</span><span class="n">img_ext</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e526ed5b12715d0453a267a1e4b5f97052621283aa84242867d9896ad0bc5ac6.png" src="../_images/e526ed5b12715d0453a267a1e4b5f97052621283aa84242867d9896ad0bc5ac6.png" />
</div>
</div>
<p>And we see that this looks much more like the AS 209 disk.</p>
</section>
<section id="incorporating-the-data">
<h3>Incorporating the data<a class="headerlink" href="#incorporating-the-data" title="Permalink to this heading">#</a></h3>
<p>Next, we’ll define another class called <code class="docutils literal notranslate"><span class="pre">VisibilityModel</span></code>. This class has an instance of <code class="docutils literal notranslate"><span class="pre">PyroDisk</span></code> as an attribute and takes the image produced by that all the way to the data and evaluates the likelihood function. We could have incorporated all of the functionality inside a single class, but we thought it was cleaner to separate the functionality this way: <code class="docutils literal notranslate"><span class="pre">PyroDisk</span></code> contains the functionality specific to producing images from the Guzmán et al. 2018 model while <code class="docutils literal notranslate"><span class="pre">VisibilityModel</span></code> contains the functionality for producing and evaluating model visibilities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VisibilityModel</span><span class="p">(</span><span class="n">PyroModule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This inherits from the PyroDisk model (which provided Bayesian parameters for the disk model) and extends it to carry the comparison all the way to the data, evaluating a likelihood.</span>

<span class="sd">    This will hold the dataset and weights, as well.</span>
<span class="sd">    </span>
<span class="sd">    The &#39;device&#39; arg will be used to optionally run our inference on the GPU.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nchan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">uu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># instantiate the PyroDisk as an attribute to this model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">PyroDisk</span><span class="p">(</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
            <span class="n">nchan</span><span class="o">=</span><span class="n">nchan</span><span class="p">,</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># store relevant coords objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">nchan</span>

        <span class="c1"># send the loose data through a DataAverager</span>
        <span class="n">averager</span> <span class="o">=</span> <span class="n">gridding</span><span class="o">.</span><span class="n">DataAverager</span><span class="p">(</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
            <span class="n">uu</span><span class="o">=</span><span class="n">uu</span><span class="p">,</span>
            <span class="n">vv</span><span class="o">=</span><span class="n">vv</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
            <span class="n">data_re</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="n">data_im</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">averager</span><span class="o">.</span><span class="n">to_pytorch_dataset</span><span class="p">()</span>
        
        <span class="c1"># extract relevant quantities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_re</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">vis_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_im</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">vis_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">weight_indexed</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># objects for forward loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icube</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">ImageCube</span><span class="p">(</span>
            <span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">,</span> <span class="n">passthrough</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flayer</span> <span class="o">=</span> <span class="n">fourier</span><span class="o">.</span><span class="n">FourierCube</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>

        <span class="c1"># create a NuFFT, but only use it for predicting samples</span>
        <span class="c1"># store the uu and vv points we might use </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">uu</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nufft</span> <span class="o">=</span> <span class="n">fourier</span><span class="o">.</span><span class="n">NuFFT</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Feed forward to calculate the model visibilities and data likelihood.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            predictive (boolean): if True, do not condition the model visibilities on the data (generally used when doing posterior predictive checks).</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">disk_packed_image_cube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="p">()</span>  <span class="c1"># use the PyroDisk to create an ImageCube</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icube</span><span class="p">(</span><span class="n">disk_packed_image_cube</span><span class="p">)</span>  <span class="c1"># identity operation for completeness</span>

        <span class="k">if</span> <span class="n">predictive</span><span class="p">:</span>
            <span class="c1"># use the NuFFT to produce and store samples</span>
            <span class="n">vis_nufft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nufft</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">pyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;vis_real&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">vis_nufft</span><span class="p">))</span>
            <span class="n">pyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;vis_imag&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">vis_nufft</span><span class="p">))</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># evaluate the likelihood</span>
            
            <span class="c1"># use the FourierCube layer to get a gridded model</span>
            <span class="n">modelVisibilityCube</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flayer</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="c1"># extract the model visibilities corresponding to the gridded data</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">modelVisibilityCube</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_re</span><span class="p">)):</span>
                <span class="c1"># condition on the real and imaginaries of the data independently</span>
                <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;obs_real&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_re</span>
                <span class="p">)</span>
                <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="s2">&quot;obs_imag&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_im</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also do a prior predictive check with the <code class="docutils literal notranslate"><span class="pre">VisibilityModel</span></code>, just like we did with the <code class="docutils literal notranslate"><span class="pre">PyroDisk</span></code>. The <code class="docutils literal notranslate"><span class="pre">forward</span></code> method of <code class="docutils literal notranslate"><span class="pre">VisibilityModel</span></code> is a bit more complex than a <code class="docutils literal notranslate"><span class="pre">forward</span></code> routine you might find in your average Pyro module. This is because we want to have the best of both worlds when it comes to producing model visibilities and (optionally) evaluating them against data.</p>
<p>As we described in the <a class="reference internal" href="../ci-tutorials/loose-visibilities.html"><span class="doc std std-doc">NuFFT</span></a> tutorial, the <a class="reference internal" href="../api.html#mpol.fourier.NuFFT" title="mpol.fourier.NuFFT"><code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.fourier.NuFFT</span></code></a> layer is designed to take an image and produce individual model visibilities corresponding to the <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(v\)</span> sampling locations of the dataset. However, with the large number of visibilities present in your average ALMA dataset (<span class="math notranslate nohighlight">\(&gt; 10^5\)</span>), computational time can start to be a burden. For many repetitive, computationally heavy tasks like evaluating the likelihood function, we will first grid the visibilities using the <code class="xref py py-class docutils literal notranslate"><span class="pre">mpol.gridder.DataAverager</span></code> and evaluate the likelihood function off of those.</p>
<p>When visualizing model or residual visibility values, it is often far more useful to work with the loose visibility values produced from the NuFFT. This is because the loose visibilities can be gridded using a weighting scheme like Briggs robust weighting, which can dramatically increase the sensitivity of the resulting image. So that is why our <code class="docutils literal notranslate"><span class="pre">VisibilityModel</span></code> uses a <a class="reference internal" href="../api.html#mpol.fourier.NuFFT" title="mpol.fourier.NuFFT"><code class="xref py py-class docutils literal notranslate"><span class="pre">NuFFT</span></code></a> layer to produce model visibilities when working in a predictive mode but otherwise uses a more efficient <a class="reference internal" href="../api.html#mpol.fourier.FourierCube" title="mpol.fourier.FourierCube"><code class="xref py py-class docutils literal notranslate"><span class="pre">FourierCube</span></code></a> layer to produce model visibilities when working in a likelihood evaluation loop.</p>
<p>Now we’ll do a predictive check with the <code class="docutils literal notranslate"><span class="pre">VisibilityModel</span></code> using the same disk values found by Guzmán et al. 2018. We will also place it on the GPU with the <code class="docutils literal notranslate"><span class="pre">.to</span></code> call, if the device is available.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we will use this object throghout the rest of the tutorial, so we&#39;ll just call it &#39;model&#39;</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">VisibilityModel</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span> <span class="n">uu</span><span class="o">=</span><span class="n">uu</span><span class="p">,</span> <span class="n">vv</span><span class="o">=</span><span class="n">vv</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Because we’ve added the <code class="docutils literal notranslate"><span class="pre">PyroDisk</span></code> module as an attribute of the <code class="docutils literal notranslate"><span class="pre">VisibilityModel</span></code>, that means that the names of the latent random variables in the <code class="docutils literal notranslate"><span class="pre">PyroDisk</span></code> have changed. We can see that by doing a simple prior predictive check (not conditional)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_check</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">p_check</span><span class="p">()</span>
<span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;disk.incl&#39;, &#39;disk.Omega&#39;, &#39;disk.x_centroid&#39;, &#39;disk.y_centroid&#39;, &#39;disk.log_A_0&#39;, &#39;disk.log_sigma_0&#39;, &#39;disk.log_ring_amplitudes&#39;, &#39;disk.ring_means&#39;, &#39;disk.log_ring_sigmas&#39;, &#39;iprofile1D&#39;, &#39;sky_cube&#39;, &#39;total_flux&#39;, &#39;vis_real&#39;, &#39;vis_imag&#39;])
</pre></div>
</div>
</div>
</div>
<p>This means that we’ll need to update the names of some of the parameters in the <code class="docutils literal notranslate"><span class="pre">guzman_values</span></code> dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guzman_disk_values</span> <span class="o">=</span> <span class="n">guzman_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">guzman_values</span><span class="p">:</span>
    <span class="n">guzman_disk_values</span><span class="p">[</span><span class="s2">&quot;disk.&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">guzman_disk_values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guzman_disk_values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;disk.x_centroid&#39;: tensor([0.0017]),
 &#39;disk.y_centroid&#39;: tensor([-0.0031]),
 &#39;disk.log_A_0&#39;: tensor([0.]),
 &#39;disk.log_sigma_0&#39;: tensor([0.8254]),
 &#39;disk.log_ring_amplitudes&#39;: tensor([[-0.5622, -0.8761, -0.9393, -1.1308, -2.3979, -1.2924, -2.0969]],
        dtype=torch.float64),
 &#39;disk.ring_means&#39;: tensor([[ 15.1300,  27.0700,  41.4200,  74.0800,  91.7600, 120.4200, 139.0600]],
        dtype=torch.float64),
 &#39;disk.log_ring_sigmas&#39;: tensor([[0.8698, 1.0689, 1.2405, 0.8657, 1.3690, 0.9930, 1.3636]],
        dtype=torch.float64),
 &#39;disk.incl&#39;: tensor([0.6088]),
 &#39;disk.Omega&#39;: tensor([1.4969])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize a Predictive object, condition on the Guzman &quot;posterior sample&quot;</span>
<span class="n">prior_predictive_conditional_vis</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">posterior_samples</span><span class="o">=</span><span class="n">guzman_disk_values</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">prior_predictive_conditional_vis</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We now see that we have <code class="docutils literal notranslate"><span class="pre">vis_real</span></code> and <code class="docutils literal notranslate"><span class="pre">vis_imag</span></code> values in the output samples. These are the “loose” model visibilities produced by the NuFFT layer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;iprofile1D&#39;, &#39;sky_cube&#39;, &#39;total_flux&#39;, &#39;vis_real&#39;, &#39;vis_imag&#39;])
</pre></div>
</div>
</div>
</div>
<p>To finalize this prior predictive check, we’ll grid and image these model and residual visibilities using the same Briggs weighting that we used for the data visibilities. We’ve written the following function that should help us visualize these quantities, since we’ll want to repeat this plot once we’ve explored the posteriors on our own.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compare_dirty_model_resid</span><span class="p">(</span><span class="n">model_real</span><span class="p">,</span> <span class="n">model_imag</span><span class="p">,</span> <span class="n">sky_cube</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

    <span class="c1"># convert PyTorch tensors to numpy </span>
    <span class="n">model_real</span> <span class="o">=</span> <span class="n">model_real</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">model_imag</span> <span class="o">=</span> <span class="n">model_imag</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="n">data_real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data_imag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="c1"># calculate the residual visibilities</span>
    <span class="n">resid_real</span> <span class="o">=</span> <span class="n">data_real</span> <span class="o">-</span> <span class="n">model_real</span> 
    <span class="n">resid_imag</span> <span class="o">=</span> <span class="n">data_imag</span> <span class="o">-</span> <span class="n">model_imag</span>

    <span class="c1"># use the dirty imager to make images</span>
    <span class="n">img_dirty</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_dirty_image</span><span class="p">(</span><span class="n">data_real</span><span class="p">,</span> <span class="n">data_imag</span><span class="p">)</span>
    <span class="n">img_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_dirty_image</span><span class="p">(</span><span class="n">model_real</span><span class="p">,</span> <span class="n">model_imag</span><span class="p">)</span>
    <span class="n">img_resid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_dirty_image</span><span class="p">(</span><span class="n">resid_real</span><span class="p">,</span> <span class="n">resid_imag</span><span class="p">)</span>
    
    <span class="c1"># determine the plot dimensions</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># in</span>
    <span class="n">cax_width</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># in </span>
    <span class="n">cax_sep</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># in</span>
    <span class="n">hmargin</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">mmargin</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="n">lmargin</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">rmargin</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">tmargin</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">bmargin</span> <span class="o">=</span> <span class="mf">0.5</span>
    
    <span class="n">ncol</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">nrow</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1"># the size of image axes + cax_sep + cax_width</span>
    <span class="n">block_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">lmargin</span> <span class="o">-</span> <span class="n">rmargin</span> <span class="o">-</span> <span class="n">mmargin</span> <span class="o">*</span> <span class="p">(</span><span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="n">ncol</span>
    <span class="n">ax_width</span> <span class="o">=</span> <span class="n">block_width</span> <span class="o">-</span> <span class="n">cax_width</span> <span class="o">-</span> <span class="n">cax_sep</span>
    <span class="n">ax_height</span> <span class="o">=</span> <span class="n">ax_width</span> 
    <span class="n">yy</span> <span class="o">=</span> <span class="n">bmargin</span> <span class="o">+</span> <span class="n">nrow</span> <span class="o">*</span> <span class="n">ax_height</span> <span class="o">+</span> <span class="p">(</span><span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">hmargin</span> <span class="o">+</span> <span class="n">tmargin</span>

    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">))</span>
        
    <span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([(</span><span class="n">lmargin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">block_width</span> <span class="o">+</span> <span class="n">mmargin</span><span class="p">))</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="n">bmargin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ax_height</span> <span class="o">+</span> <span class="n">hmargin</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">yy</span><span class="p">,</span> <span class="n">ax_width</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="n">ax_height</span><span class="o">/</span><span class="n">yy</span><span class="p">]))</span>
            <span class="n">ca</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([(</span><span class="n">lmargin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">block_width</span> <span class="o">+</span> <span class="n">mmargin</span><span class="p">)</span> <span class="o">+</span> <span class="n">ax_width</span> <span class="o">+</span> <span class="n">cax_sep</span><span class="p">)</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="n">bmargin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ax_height</span> <span class="o">+</span> <span class="n">hmargin</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">yy</span><span class="p">,</span> <span class="n">cax_width</span><span class="o">/</span><span class="n">xx</span><span class="p">,</span> <span class="n">ax_height</span><span class="o">/</span><span class="n">yy</span><span class="p">]))</span>
        
        <span class="c1"># prepend to list to get order correct</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">ax</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">ca</span> <span class="o">+</span> <span class="n">cax</span>

    <span class="n">cbars</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">comb_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">img_dirty</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="n">img_model</span><span class="p">[</span><span class="n">chan</span><span class="p">]])</span>
    <span class="n">scale_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">comb_img</span><span class="p">)</span>
    <span class="n">scale_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">comb_img</span><span class="p">)</span>
    
    <span class="n">im_dirty</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_dirty</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">scale_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scale_max</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;dirty image&quot;</span><span class="p">)</span>
    <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_dirty</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="n">im_model</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sky_cube</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="n">chan</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;model image&quot;</span><span class="p">)</span>
    <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_model</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="n">im_model_vis</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_model</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">scale_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scale_max</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;model vis imaged&quot;</span><span class="p">)</span>
    <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_model_vis</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="n">rkw</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rkw</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bwr_r&quot;</span>
    <span class="n">vvmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img_resid</span><span class="p">[</span><span class="n">chan</span><span class="p">]))</span>
    <span class="n">im_resid</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_resid</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="o">**</span><span class="n">rkw</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vvmax</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vvmax</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;residual vis imaged&quot;</span><span class="p">)</span>
    <span class="n">cbars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_resid</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">cbar</span> <span class="ow">in</span> <span class="n">cbars</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Jy/$\mathrm</span><span class="si">{arcsec}</span><span class="s2">^2$&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta \alpha \cos \delta$ [$</span><span class="si">{}</span><span class="s2">^{\prime\prime}$]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta \delta$ [$</span><span class="si">{}</span><span class="s2">^{\prime\prime}$]&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
        <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>    
        
    
    <span class="k">return</span> <span class="n">fig</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">compare_dirty_model_resid</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;vis_real&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;vis_imag&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;sky_cube&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/56008844b6f9c01407995476c0f672a6895c89f7513e35e6607e289d89419360.png" src="../_images/56008844b6f9c01407995476c0f672a6895c89f7513e35e6607e289d89419360.png" />
</div>
</div>
<p>Ok, there is still some structure in the residuals, but at least we can be reasonably confident that the Pyro model is producing images that have the right flux and orientation and that the Fourier layers are producing reasonable model visibilities. In the next sections we will do Bayesian inference of the model parameters and hopefully this will deliver us a set that will further reduce the scale of the residuals.</p>
</section>
</section>
<section id="parameter-inference-with-stochastic-variational-inference-svi">
<h2>Parameter inference with Stochastic Variational Inference (SVI)<a class="headerlink" href="#parameter-inference-with-stochastic-variational-inference-svi" title="Permalink to this heading">#</a></h2>
<p>Now we’ll use Stochastic Variational Inference (SVI) to run the inference loop.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyro.infer</span> <span class="kn">import</span> <span class="n">SVI</span><span class="p">,</span> <span class="n">Trace_ELBO</span>
<span class="kn">from</span> <span class="nn">pyro.infer.autoguide</span> <span class="kn">import</span> <span class="n">AutoNormal</span>
<span class="kn">from</span> <span class="nn">pyro.infer.autoguide.initialization</span> <span class="kn">import</span> <span class="n">init_to_sample</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># define SVI guide</span>
<span class="n">guide</span> <span class="o">=</span> <span class="n">AutoNormal</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">init_loc_fn</span><span class="o">=</span><span class="n">init_to_sample</span><span class="p">)</span>

<span class="n">adam</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">({</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">})</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">adam</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">Trace_ELBO</span><span class="p">())</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">15000</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">loss_tracker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">)</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">):</span>
    <span class="c1"># calculate the loss and take a gradient step</span>
    <span class="n">loss_tracker</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">predictive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization took </span><span class="si">{:}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="c1"># write loss to file </span>
<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_tracker</span><span class="p">)</span>
<span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;loss.csv&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization took 279.66143441200256s
</pre></div>
</div>
</div>
</div>
<p>Note that, because we are in a Jupyter notebook tutorial, we don’t need to save and then load the output from a run, it’s just stored in memory. In a normal workflow, though, you might wish to have one script that runs the optimization loop (perhaps via a batch submission script on a cluster) and then a separate script that plots the results. In that case, you’ll want to save the parameter values of the guide after optimization. Here is one way to save them</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">param_store</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span>
<span class="n">param_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;param_store&quot;</span><span class="p">)</span>

<span class="c1"># view items</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">param_store</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>And then in your plotting script, you’ll want to re-initialize the model and the guide, and then you can load the parameter store into them. For example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># define SVI guide</span>
<span class="n">guide</span> <span class="o">=</span> <span class="n">AutoNormal</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">init_loc_fn</span><span class="o">=</span><span class="n">init_to_mean</span><span class="p">)</span>

<span class="n">param_store</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span>
<span class="n">param_store</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;param_store&quot;</span><span class="p">)</span>

<span class="c1"># need to run the guide step after, otherwise &quot;no stochastic sites&quot;</span>
<span class="n">guide</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, let’s plot the loss values to see how we converged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;loss.csv&quot;</span><span class="p">)</span>
<span class="c1"># subtract the minimum value </span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span>
<span class="n">loss</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

<span class="c1"># plot loss</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/10bc1004df48f1406ed85b263ac8c7b27b1a53e477cbe9ca9c5b33b966fffed0.png" src="../_images/10bc1004df48f1406ed85b263ac8c7b27b1a53e477cbe9ca9c5b33b966fffed0.png" />
</div>
</div>
<section id="visualization-of-samples">
<h3>Visualization of samples<a class="headerlink" href="#visualization-of-samples" title="Permalink to this heading">#</a></h3>
<p>We can visualize the posteriors in multiple ways. Since we used an <a class="reference external" href="https://docs.pyro.ai/en/stable/infer.autoguide.html#autonormal">AutoNormal</a> guide, this means that, by construction, the posteriors will be 1D Gaussians on each parameter, with no covariance between them. (This may be physically unrealistic, which we’ll address in a moment). So, one way of reporting the posteriors is simply to report the mean and standard deviation of each of the guide Gaussians. There is a convenience routine, <code class="docutils literal notranslate"><span class="pre">guide.quantiles()</span></code>, that will report the quantiles of the Gaussian distribution for this guide.</p>
<p>Let’s go a step further and examine the posteriors using some visualization routines provided by the <a class="reference external" href="https://python.arviz.org/en/stable/">ArviZ</a> package. To start, we want to generate samples from the posterior distributions.</p>
<p>As before, we’ll use the <code class="docutils literal notranslate"><span class="pre">Predictive</span></code> routine to generate samples. This time, though, we’ll pass in the <code class="docutils literal notranslate"><span class="pre">guide</span></code>, which stores the variational distribution that is approximated to the posterior distribution. And, we’ll start just by visualizing a subset of the parameters using the <code class="docutils literal notranslate"><span class="pre">return_sites</span></code> argument.</p>
<p>We can generate samples from the approximate posterior as follows</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;disk.incl&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.Omega&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.x_centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.y_centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_A_0&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_sigma_0&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_ring_amplitudes&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.ring_means&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_ring_sigmas&#39;</span><span class="p">],</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">)(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># extract samples from the Pyro Predictive object and convert units for convenience</span>
<span class="n">dict_samples</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># convert from radians to degrees</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;disk.incl&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.Omega&quot;</span><span class="p">]:</span>
    <span class="n">dict_samples</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/=</span> <span class="n">deg</span>
    
<span class="c1"># convert from log values</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;disk.log_A_0&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.log_sigma_0&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.log_ring_amplitudes&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.log_ring_sigmas&quot;</span><span class="p">]:</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;log_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">dict_samples</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">dict_samples</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<p>and then convert these samples to an ArviZ InferenceData object</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">convert_to_inference_data</span><span class="p">(</span><span class="n">dict_samples</span><span class="p">)</span>
<span class="n">dataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
            <div>
              <div class='xr-header'>
                <div class="xr-obj-type">arviz.InferenceData</div>
              </div>
              <ul class="xr-sections group-sections">
              
            <li class = "xr-section-item">
                  <input id="idata_posterioraf351906-1597-4d15-b6bd-696114d86c53" class="xr-section-summary-in" type="checkbox">
                  <label for="idata_posterioraf351906-1597-4d15-b6bd-696114d86c53" class = "xr-section-summary">posterior</label>
                  <div class="xr-section-inline-details"></div>
                  <div class="xr-section-details">
                      <ul id="xr-dataset-coord-list" class="xr-var-list">
                          <div style="padding-left:2rem;"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:                     (chain: 1, draw: 2000,
                                 disk.ring_means_dim_0: 7,
                                 disk.ring_amplitudes_dim_0: 7,
                                 disk.ring_sigmas_dim_0: 7)
Coordinates:
  * chain                       (chain) int64 0
  * draw                        (draw) int64 0 1 2 3 4 ... 1996 1997 1998 1999
  * disk.ring_means_dim_0       (disk.ring_means_dim_0) int64 0 1 2 3 4 5 6
  * disk.ring_amplitudes_dim_0  (disk.ring_amplitudes_dim_0) int64 0 1 2 3 4 5 6
  * disk.ring_sigmas_dim_0      (disk.ring_sigmas_dim_0) int64 0 1 2 3 4 5 6
Data variables:
    disk.incl                   (chain, draw) float32 33.51 33.63 ... 33.54
    disk.Omega                  (chain, draw) float32 85.72 85.89 ... 85.57
    disk.x_centroid             (chain, draw) float32 9.227e-05 ... 1.401e-05
    disk.y_centroid             (chain, draw) float32 -0.001854 ... -0.003044
    disk.ring_means             (chain, draw, disk.ring_means_dim_0) float64 ...
    disk.A_0                    (chain, draw) float32 1.817 1.803 ... 1.79 1.818
    disk.sigma_0                (chain, draw) float32 3.152 3.12 ... 3.108 3.124
    disk.ring_amplitudes        (chain, draw, disk.ring_amplitudes_dim_0) float32 ...
    disk.ring_sigmas            (chain, draw, disk.ring_sigmas_dim_0) float32 ...
Attributes:
    created_at:     2023-12-13T12:22:56.522548
    arviz_version:  0.16.1</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-bf08aee7-e21b-4bd1-a418-0a2a8773a895' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-bf08aee7-e21b-4bd1-a418-0a2a8773a895' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>chain</span>: 1</li><li><span class='xr-has-index'>draw</span>: 2000</li><li><span class='xr-has-index'>disk.ring_means_dim_0</span>: 7</li><li><span class='xr-has-index'>disk.ring_amplitudes_dim_0</span>: 7</li><li><span class='xr-has-index'>disk.ring_sigmas_dim_0</span>: 7</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-5ece74a7-36d8-4faa-b5be-17e605649b9b' class='xr-section-summary-in' type='checkbox'  checked><label for='section-5ece74a7-36d8-4faa-b5be-17e605649b9b' class='xr-section-summary' >Coordinates: <span>(5)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>chain</span></div><div class='xr-var-dims'>(chain)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0</div><input id='attrs-830c77e6-9209-4267-b10b-4a8500c2ced8' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-830c77e6-9209-4267-b10b-4a8500c2ced8' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-3f26bd6d-4c64-4026-87a5-9ed92b4b020c' class='xr-var-data-in' type='checkbox'><label for='data-3f26bd6d-4c64-4026-87a5-9ed92b4b020c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>draw</span></div><div class='xr-var-dims'>(draw)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1 2 3 4 ... 1996 1997 1998 1999</div><input id='attrs-14b61224-544d-4436-a0a3-9c6a65598aa5' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-14b61224-544d-4436-a0a3-9c6a65598aa5' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-6e2c934a-ed18-43b1-bef3-f0069056cc35' class='xr-var-data-in' type='checkbox'><label for='data-6e2c934a-ed18-43b1-bef3-f0069056cc35' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([   0,    1,    2, ..., 1997, 1998, 1999])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>disk.ring_means_dim_0</span></div><div class='xr-var-dims'>(disk.ring_means_dim_0)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1 2 3 4 5 6</div><input id='attrs-dad1b9b9-3d3b-44c4-828a-284e2ad21e6e' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-dad1b9b9-3d3b-44c4-828a-284e2ad21e6e' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a254632f-67da-4f51-8c72-a0f8da9ad268' class='xr-var-data-in' type='checkbox'><label for='data-a254632f-67da-4f51-8c72-a0f8da9ad268' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0, 1, 2, 3, 4, 5, 6])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>disk.ring_amplitudes_dim_0</span></div><div class='xr-var-dims'>(disk.ring_amplitudes_dim_0)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1 2 3 4 5 6</div><input id='attrs-e64343e6-0d55-473d-b653-3f5744e4d8b8' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e64343e6-0d55-473d-b653-3f5744e4d8b8' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-374f2f2c-3efd-4bc7-8640-690cc526597b' class='xr-var-data-in' type='checkbox'><label for='data-374f2f2c-3efd-4bc7-8640-690cc526597b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0, 1, 2, 3, 4, 5, 6])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>disk.ring_sigmas_dim_0</span></div><div class='xr-var-dims'>(disk.ring_sigmas_dim_0)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1 2 3 4 5 6</div><input id='attrs-cd56e339-6df6-4f97-9cec-07edf052536c' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-cd56e339-6df6-4f97-9cec-07edf052536c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-baefa9c3-7c56-4fe8-bf31-04d6a0b42802' class='xr-var-data-in' type='checkbox'><label for='data-baefa9c3-7c56-4fe8-bf31-04d6a0b42802' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0, 1, 2, 3, 4, 5, 6])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-fbdd80c3-199c-41d3-b63e-8c7fb860adf4' class='xr-section-summary-in' type='checkbox'  checked><label for='section-fbdd80c3-199c-41d3-b63e-8c7fb860adf4' class='xr-section-summary' >Data variables: <span>(9)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>disk.incl</span></div><div class='xr-var-dims'>(chain, draw)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>33.51 33.63 33.61 ... 33.55 33.54</div><input id='attrs-9003a53a-6f22-4c17-b5d2-9e1c7b2c06f0' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-9003a53a-6f22-4c17-b5d2-9e1c7b2c06f0' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5c01f900-8483-414e-9cb1-1a4c2abd3b78' class='xr-var-data-in' type='checkbox'><label for='data-5c01f900-8483-414e-9cb1-1a4c2abd3b78' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[33.5108 , 33.63121, 33.61313, ..., 33.5157 , 33.54818, 33.54471]],
      dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.Omega</span></div><div class='xr-var-dims'>(chain, draw)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>85.72 85.89 85.67 ... 85.75 85.57</div><input id='attrs-7f25fb4f-d651-4e83-848e-afbc5d08ef1e' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-7f25fb4f-d651-4e83-848e-afbc5d08ef1e' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-e7cdcac8-3f4d-435a-b3a5-b4b8b06dc5ad' class='xr-var-data-in' type='checkbox'><label for='data-e7cdcac8-3f4d-435a-b3a5-b4b8b06dc5ad' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[85.72048 , 85.88544 , 85.67413 , ..., 85.831924, 85.748634,
        85.57317 ]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.x_centroid</span></div><div class='xr-var-dims'>(chain, draw)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>9.227e-05 -0.0003432 ... 1.401e-05</div><input id='attrs-2d330e16-e18b-42fe-9561-6d6c080ed11a' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-2d330e16-e18b-42fe-9561-6d6c080ed11a' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-4733d285-71dc-493f-b8ae-558ee476ea78' class='xr-var-data-in' type='checkbox'><label for='data-4733d285-71dc-493f-b8ae-558ee476ea78' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[ 9.2272210e-05, -3.4316586e-04, -7.4053043e-04, ...,
        -4.9799040e-04,  1.5853302e-04,  1.4009536e-05]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.y_centroid</span></div><div class='xr-var-dims'>(chain, draw)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>-0.001854 -0.002071 ... -0.003044</div><input id='attrs-cad68320-72f3-436f-a903-6be099d1ba0b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-cad68320-72f3-436f-a903-6be099d1ba0b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-6e86b2c4-f6c1-49c2-928d-336b7546b557' class='xr-var-data-in' type='checkbox'><label for='data-6e86b2c4-f6c1-49c2-928d-336b7546b557' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[-0.0018536 , -0.00207101, -0.0013707 , ..., -0.00208666,
        -0.00210838, -0.00304355]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.ring_means</span></div><div class='xr-var-dims'>(chain, draw, disk.ring_means_dim_0)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>14.76 27.76 45.6 ... 119.2 132.9</div><input id='attrs-bbeca255-efcc-4580-b406-2d776edb07dc' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-bbeca255-efcc-4580-b406-2d776edb07dc' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-57cc4728-ac2f-412d-8d7b-24c98c2b278c' class='xr-var-data-in' type='checkbox'><label for='data-57cc4728-ac2f-412d-8d7b-24c98c2b278c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[ 14.76038316,  27.76218413,  45.60421813, ...,  94.00711467,
         119.22092318, 133.27486235],
        [ 14.74505476,  27.7741436 ,  45.42015997, ...,  97.18651058,
         119.14625352, 132.61809996],
        [ 14.71052237,  27.77960727,  45.33458174, ...,  94.28439367,
         119.17935166, 132.80203314],
        ...,
        [ 14.75474935,  27.8238981 ,  45.34722634, ...,  95.04365216,
         119.05532458, 132.42790884],
        [ 14.72887404,  27.82047374,  45.3351125 , ...,  95.30818495,
         119.24067829, 132.75315894],
        [ 14.72457681,  27.74822702,  45.17390774, ...,  95.19192697,
         119.16591981, 132.86425054]]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.A_0</span></div><div class='xr-var-dims'>(chain, draw)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>1.817 1.803 1.816 ... 1.79 1.818</div><input id='attrs-71fbbce2-adef-4bda-bdc1-7b1d29139b39' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-71fbbce2-adef-4bda-bdc1-7b1d29139b39' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ef2fb515-fb5e-4220-a364-23eb22ba17d5' class='xr-var-data-in' type='checkbox'><label for='data-ef2fb515-fb5e-4220-a364-23eb22ba17d5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[1.8170406, 1.8031286, 1.8161646, ..., 1.8090339, 1.7895997,
        1.8177171]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.sigma_0</span></div><div class='xr-var-dims'>(chain, draw)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>3.152 3.12 3.128 ... 3.108 3.124</div><input id='attrs-bbd6b639-fcc1-46d6-be29-b14f910210b3' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-bbd6b639-fcc1-46d6-be29-b14f910210b3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-bd185bfd-ce9e-4af9-a888-8e3bfa107c30' class='xr-var-data-in' type='checkbox'><label for='data-bd185bfd-ce9e-4af9-a888-8e3bfa107c30' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[3.1517222, 3.1204388, 3.128118 , ..., 3.1164646, 3.1082885,
        3.1244774]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.ring_amplitudes</span></div><div class='xr-var-dims'>(chain, draw, disk.ring_amplitudes_dim_0)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>0.514 0.3343 ... 0.09983 0.01713</div><input id='attrs-871411c6-f7e0-46de-8601-019b8fe2915f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-871411c6-f7e0-46de-8601-019b8fe2915f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-75551e5a-6b63-421f-9708-f8a000e51d43' class='xr-var-data-in' type='checkbox'><label for='data-75551e5a-6b63-421f-9708-f8a000e51d43' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[0.5139939 , 0.3343491 , 0.13191153, ..., 0.11675651,
         0.10089631, 0.01703466],
        [0.5108533 , 0.33418658, 0.13093996, ..., 0.12046663,
         0.10185476, 0.01687217],
        [0.5145814 , 0.3346706 , 0.13093549, ..., 0.10970192,
         0.10050295, 0.01679773],
        ...,
        [0.5190453 , 0.33501744, 0.1319689 , ..., 0.11169106,
         0.10185203, 0.01691243],
        [0.51616436, 0.3351659 , 0.1316496 , ..., 0.11070041,
         0.10105772, 0.01686522],
        [0.513829  , 0.3347053 , 0.130847  , ..., 0.10683961,
         0.0998261 , 0.01712571]]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>disk.ring_sigmas</span></div><div class='xr-var-dims'>(chain, draw, disk.ring_sigmas_dim_0)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>2.519 11.15 5.398 ... 4.076 13.06</div><input id='attrs-f0dde8b3-6665-44c8-bba5-62380037c0eb' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-f0dde8b3-6665-44c8-bba5-62380037c0eb' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-73f633b4-d9a1-40e1-8e98-41b17ae8d999' class='xr-var-data-in' type='checkbox'><label for='data-73f633b4-d9a1-40e1-8e98-41b17ae8d999' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[ 2.519021  , 11.149424  ,  5.3977523 , ...,  0.42715493,
          4.0636454 , 12.95428   ],
        [ 2.4972246 , 11.151704  ,  5.439672  , ...,  0.4823042 ,
          4.087729  , 13.25132   ],
        [ 2.5009086 , 11.134016  ,  5.399638  , ...,  0.43363482,
          4.095154  , 13.069245  ],
        ...,
        [ 2.5018559 , 11.1147175 ,  5.4299116 , ...,  0.5062876 ,
          4.1120877 , 12.9289055 ],
        [ 2.5032961 , 11.142644  ,  5.4486494 , ...,  0.50305444,
          4.0914936 , 13.010602  ],
        [ 2.507539  , 11.129225  ,  5.431214  , ...,  0.46920383,
          4.0760446 , 13.059964  ]]], dtype=float32)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-bb7a7f4d-5e72-4815-91a1-94a63888f3e7' class='xr-section-summary-in' type='checkbox'  ><label for='section-bb7a7f4d-5e72-4815-91a1-94a63888f3e7' class='xr-section-summary' >Indexes: <span>(5)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>chain</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-aa44ea8a-fd86-443b-9fcd-f48ddc9ca426' class='xr-index-data-in' type='checkbox'/><label for='index-aa44ea8a-fd86-443b-9fcd-f48ddc9ca426' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Int64Index([0], dtype=&#x27;int64&#x27;, name=&#x27;chain&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>draw</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-2800c54b-1513-4b2c-8f30-2ac1c85209e3' class='xr-index-data-in' type='checkbox'/><label for='index-2800c54b-1513-4b2c-8f30-2ac1c85209e3' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Int64Index([   0,    1,    2,    3,    4,    5,    6,    7,    8,    9,
            ...
            1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999],
           dtype=&#x27;int64&#x27;, name=&#x27;draw&#x27;, length=2000))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>disk.ring_means_dim_0</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-f8a8abf3-a3bf-4232-8ee8-b0feb49ca372' class='xr-index-data-in' type='checkbox'/><label for='index-f8a8abf3-a3bf-4232-8ee8-b0feb49ca372' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Int64Index([0, 1, 2, 3, 4, 5, 6], dtype=&#x27;int64&#x27;, name=&#x27;disk.ring_means_dim_0&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>disk.ring_amplitudes_dim_0</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-bd7cba4c-192f-491e-a6f7-0938ad519af4' class='xr-index-data-in' type='checkbox'/><label for='index-bd7cba4c-192f-491e-a6f7-0938ad519af4' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Int64Index([0, 1, 2, 3, 4, 5, 6], dtype=&#x27;int64&#x27;, name=&#x27;disk.ring_amplitudes_dim_0&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>disk.ring_sigmas_dim_0</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-428555e3-ffab-47b3-b9cc-2a5d460f470e' class='xr-index-data-in' type='checkbox'/><label for='index-428555e3-ffab-47b3-b9cc-2a5d460f470e' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Int64Index([0, 1, 2, 3, 4, 5, 6], dtype=&#x27;int64&#x27;, name=&#x27;disk.ring_sigmas_dim_0&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-8b7f95e5-5ca3-49f1-ab97-9463b93409a2' class='xr-section-summary-in' type='checkbox'  checked><label for='section-8b7f95e5-5ca3-49f1-ab97-9463b93409a2' class='xr-section-summary' >Attributes: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>created_at :</span></dt><dd>2023-12-13T12:22:56.522548</dd><dt><span>arviz_version :</span></dt><dd>0.16.1</dd></dl></div></li></ul></div></div><br></div>
                      </ul>
                  </div>
            </li>
            
              </ul>
            </div>
            <style> /* CSS stylesheet for displaying InferenceData objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-sections.group-sections {
  grid-template-columns: auto;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt, dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
.xr-wrap{width:700px!important;} </style></div></div>
</div>
<p>Then, it is easy to use the ArviZ plotting routines to make many diagnostic plots. To start, let’s visualize the 1D marginal posteriors</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_posterior</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;disk.Omega&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.incl&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.A_0&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.sigma_0&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e8ef27571d28dc8e65cbd93b6e37663273a79ea17cedc386151179b3e1a53dca.png" src="../_images/e8ef27571d28dc8e65cbd93b6e37663273a79ea17cedc386151179b3e1a53dca.png" />
</div>
</div>
<p>And, we can also visualize the pairwise 2D marginal distributions (often called a “triangle” or “corner” plot)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;disk.ring_means&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/root/.local/lib/python3.10/site-packages/xarray/core/utils.py:494: FutureWarning: The return type of `Dataset.dims` will be changed to return a set of dimension names in future, in order to be more consistent with `DataArray.dims`. To access a mapping from dimension names to lengths, please use `Dataset.sizes`.
  warnings.warn(
</pre></div>
</div>
<img alt="../_images/6b3521094ba6c4f8c81719af8db44c631fca5a9830180265ff1153fa991682ef.png" src="../_images/6b3521094ba6c4f8c81719af8db44c631fca5a9830180265ff1153fa991682ef.png" />
</div>
</div>
<p>As we mentioned, the lack of correlation between any parameters is <em>imposed</em> by the simple SVI guide that we used. This could be an issue if there were strong correlations between parameters. We’ll address this limitiation in the next section by using a guide that incorporates correlations between parameters.</p>
<p>But first, let’s see what the model and residuals look like for this optimized posterior distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vis_real&#39;</span><span class="p">,</span> <span class="s1">&#39;vis_imag&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_cube&#39;</span><span class="p">],</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">predictive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">compare_dirty_model_resid</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s2">&quot;vis_real&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;vis_imag&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;sky_cube&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c1e608c65fd7bfc21fb687e0f7e8062eec3265a5e36c8ab62f9f8db077e1124a.png" src="../_images/c1e608c65fd7bfc21fb687e0f7e8062eec3265a5e36c8ab62f9f8db077e1124a.png" />
</div>
</div>
<p>And the 1D profile – here we’ll overplot 50 draws.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;iprofile1D&#39;</span><span class="p">],</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">)(</span><span class="n">predictive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;iprofile1D&quot;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;radius [au]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$I_\nu$ [Jy $\mathrm</span><span class="si">{arcsec}</span><span class="s2">^{-2}$]&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1fc87059e7edb555c9aa22d7ae3a75c6b319c7c7a651bf537eb6d8dac533e6a4.png" src="../_images/1fc87059e7edb555c9aa22d7ae3a75c6b319c7c7a651bf537eb6d8dac533e6a4.png" />
</div>
</div>
<p>We see that there is very little dispersion in these draws from the posterior. This is a feature of the high signal to noise of the dataset but could also be from the parameterization of our model (e.g., not flexible enough, more Gaussian rings required, rings of different shapes, etc…) or the restrictions placed by the <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> guide (parameters are uncorrelated). We would expect some of the ring parameters to be correlated with each other (especially those at or below the resolution of the observations), so we’ll explore this in the next section.</p>
</section>
</section>
<section id="svi-with-a-automultivariatenormal-model">
<h2>SVI with a AutoMultivariateNormal Model<a class="headerlink" href="#svi-with-a-automultivariatenormal-model" title="Permalink to this heading">#</a></h2>
<p>Our first attempt at inference with SVI using the AutoNormal guide seemed to go pretty well. But it’s probably unrealistic to assume that there is no correlation between parameters in the model. To address this, we can use a more sophisticated variational guide to approximate the true posterior.</p>
<p>The next logical step would be to use a guide that still used a Normal distribution to approximate the posterior, but also allowed for correlations between parameters. Fortunately, Pyro provides an <code class="docutils literal notranslate"><span class="pre">AutoMultivariateNormal</span></code> guide that does just this. Let’s repeat the SVI process and see what, if anything, changes with our inferred posteriors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyro.infer.autoguide</span> <span class="kn">import</span> <span class="n">AutoMultivariateNormal</span><span class="p">,</span> <span class="n">init_to_mean</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># define SVI guide</span>
<span class="n">guide</span> <span class="o">=</span> <span class="n">AutoMultivariateNormal</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">init_loc_fn</span><span class="o">=</span><span class="n">init_to_mean</span><span class="p">)</span>

<span class="n">adam</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">({</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">})</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">SVI</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">adam</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">Trace_ELBO</span><span class="p">())</span>

<span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">15000</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">loss_tracker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">)</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">):</span>
    <span class="c1"># calculate the loss and take a gradient step</span>
    <span class="n">loss_tracker</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">predictive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization took </span><span class="si">{:}</span><span class="s2">s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="c1"># write loss to file </span>
<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
<span class="n">table</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss_tracker</span><span class="p">)</span>
<span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;loss.csv&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization took 685.1601960659027s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;loss.csv&quot;</span><span class="p">)</span>
<span class="c1"># subtract the minimum value </span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span>
<span class="n">loss</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>

<span class="c1"># plot loss</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c257c788bf798623413649c345740e2ff25887e7fbd910e107ef2eb03dbf88c1.png" src="../_images/c257c788bf798623413649c345740e2ff25887e7fbd910e107ef2eb03dbf88c1.png" />
</div>
</div>
<section id="id1">
<h3>Visualization of samples<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>We’ll follow a similar procedure as with the <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> guide.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;disk.incl&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.Omega&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.x_centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.y_centroid&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_A_0&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_sigma_0&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_ring_amplitudes&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.ring_means&#39;</span><span class="p">,</span> <span class="s1">&#39;disk.log_ring_sigmas&#39;</span><span class="p">],</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">)(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>disk.incl: torch.Size([2000])
disk.Omega: torch.Size([2000])
disk.x_centroid: torch.Size([2000])
disk.y_centroid: torch.Size([2000])
disk.log_A_0: torch.Size([2000])
disk.log_sigma_0: torch.Size([2000])
disk.log_ring_amplitudes: torch.Size([2000, 7])
disk.ring_means: torch.Size([2000, 7])
disk.log_ring_sigmas: torch.Size([2000, 7])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract samples from the Pyro Predictive object and convert units for convenience</span>
<span class="n">dict_samples</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="c1"># convert from radians to degrees</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;disk.incl&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.Omega&quot;</span><span class="p">]:</span>
    <span class="n">dict_samples</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/=</span> <span class="n">deg</span>
    
<span class="c1"># convert to actual value</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;disk.log_A_0&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.log_sigma_0&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.log_ring_amplitudes&quot;</span><span class="p">,</span> <span class="s2">&quot;disk.log_ring_sigmas&quot;</span><span class="p">]:</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;log_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">dict_samples</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">dict_samples</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>    
    
<span class="n">dataset</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">convert_to_inference_data</span><span class="p">(</span><span class="n">dict_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Because it is hard to visualize the posteriors for all 27 parameters in a single plot, we will plot pairwise a subset of the variables at a time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;disk.ring_means&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/root/.local/lib/python3.10/site-packages/xarray/core/utils.py:494: FutureWarning: The return type of `Dataset.dims` will be changed to return a set of dimension names in future, in order to be more consistent with `DataArray.dims`. To access a mapping from dimension names to lengths, please use `Dataset.sizes`.
  warnings.warn(
</pre></div>
</div>
<img alt="../_images/9bf3345001ee3112bcd4545caa1930410a9b072baea97fd0d81372493d9ef54b.png" src="../_images/9bf3345001ee3112bcd4545caa1930410a9b072baea97fd0d81372493d9ef54b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;disk.ring_sigmas&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d3ebdf3d523bacc51d5e4fe4c5098656eaa7dc33a31c06cad2321ff1279673f0.png" src="../_images/d3ebdf3d523bacc51d5e4fe4c5098656eaa7dc33a31c06cad2321ff1279673f0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;disk.ring_amplitudes&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e006ad024d61956001a3da8b5ec697cdcee3897131988d6e2548d08bd0a50601.png" src="../_images/e006ad024d61956001a3da8b5ec697cdcee3897131988d6e2548d08bd0a50601.png" />
</div>
</div>
<p>With the more flexible guide, the correlations between parameters are more accurately captured. Now let’s see what the model and residuals look like for this optimized posterior distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vis_real&#39;</span><span class="p">,</span> <span class="s1">&#39;vis_imag&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_cube&#39;</span><span class="p">],</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">predictive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">compare_dirty_model_resid</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s2">&quot;vis_real&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;vis_imag&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;sky_cube&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f47549bf20d85887561d46f05f6f600e6cda692ec90dc1b9deb55246ca2c48a9.png" src="../_images/f47549bf20d85887561d46f05f6f600e6cda692ec90dc1b9deb55246ca2c48a9.png" />
</div>
</div>
<p>It’s hard to tell much of a difference with the model and residual images.</p>
<p>However, when we plot many draws from the 1D profile</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;iprofile1D&#39;</span><span class="p">],</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">)(</span><span class="n">predictive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;iprofile1D&quot;</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;radius [au]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$I_\nu$ [Jy $\mathrm</span><span class="si">{arcsec}</span><span class="s2">^{-2}$]&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2a1476ad6381433c8a3d33e19a927dd3519284f60515dc7669583bf68a7e0578.png" src="../_images/2a1476ad6381433c8a3d33e19a927dd3519284f60515dc7669583bf68a7e0578.png" />
</div>
</div>
<p>We see that there is a <em>slightly</em> larger scatter in the draws compared to the <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> guide, most noticeable around 40 au. This is because the <code class="docutils literal notranslate"><span class="pre">AutoMultivariateNormal</span></code> guide captured more of the covariance between parameters, resulting in a greater dispersion of draws.</p>
<p>Encouragingly, both our image and 1D profile results compare favorably with those found by <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..48G/abstract">Guzmán et al. 2018</a> (compare their Figures 2 &amp; 4).</p>
<p>The true uncertainty in the radial profile may still be underestimated. As we discussed, one source could be the parameterization of the model. In reality, the disk rings are not perfect Gaussian shapes, and so, as currently implemented, our model could never capture the true intensity profile.</p>
<p>In our opinion, SVI is a very useful inference technique because of its speed and scalability. There is the risk, though, that your guide distribution does not fully capture complex covariances of your posterior distributions. Perhaps some parameter posteriors are significantly non-Gaussian or banana-shaped, and therefore not able to be captured by the multivariate Normal guide. This risk can be hard to assess from SVI fits alone, though there are steps you can take by trying out more <a class="reference external" href="https://docs.pyro.ai/en/stable/infer.autoguide.html#">complex guides</a> or <a class="reference external" href="https://pyro.ai/examples/svi_part_i.html#Guide">writing your own</a>, parameterized around anticipated covariances.</p>
</section>
</section>
<section id="parameter-inference-with-mcmc">
<h2>Parameter inference with MCMC<a class="headerlink" href="#parameter-inference-with-mcmc" title="Permalink to this heading">#</a></h2>
<p>If these expanded SVI approaches are unsatisfactory and accurately measuring parameter uncertainties and covariances is critical to your science problem, it may make sense to switch to a more accurate inference algorithm like Markov Chain Monte Carlo (MCMC). With gradient-enabled samplers like Hamiltonian Monte Carlo (HMC) and the No U-Turn Sampler (NUTS), MCMC sampling can still be quite fast compared to traditional MCMC algorithms like Metropolis-Hastings.</p>
<p>To sample this model using MCMC and NUTS, the following steps are required</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyro.infer</span> <span class="kn">import</span> <span class="n">MCMC</span><span class="p">,</span> <span class="n">NUTS</span>
<span class="kn">from</span> <span class="nn">pyro.infer.autoguide.initialization</span> <span class="kn">import</span> <span class="n">init_to_sample</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">VisibilityModel</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span> <span class="n">uu</span><span class="o">=</span><span class="n">uu</span><span class="p">,</span> <span class="n">vv</span><span class="o">=</span><span class="n">vv</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">NUTS</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">init_strategy</span><span class="o">=</span><span class="n">init_to_sample</span><span class="p">)</span>

<span class="n">mcmc</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">mcmc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">predictive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">mcmc</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
</pre></div>
</div>
<p>If you will be running this on the GPU (at least as of Pyro 1.8.4), you will also need to change latent variable definitions in <code class="docutils literal notranslate"><span class="pre">PyroDisk</span></code> such that they are instantiated from torch tensors on the GPU, like so</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">log_A_0</span> <span class="o">=</span> <span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="mf">0.3</span><span class="p">))</span>
</pre></div>
</div>
<p>This is necessary to place these sample objects on the GPU for use in MCMC (see also this <a class="reference external" href="https://forum.pyro.ai/t/pyrosample-and-cuda-gpu/4328">Pyro issue</a>) so that you don’t get conflicts that some tensors are on the CPU while others are on the GPU. It’s not clear to us why this change is necessary for MCMC but not for the SVI algorithms.</p>
<p>Reassuringly, we found that the parameter constraints provided by MCMC were comparable to those provided by SVI with the MultiDiagonal guide. We found that the MCMC NUTS run took about a 1.5 hours to run two independent chains on a GPU. This is still tractable but notably slower than the roughly 5 minutes it took with SVI to find the posterior distributions in this tutorial.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../ci-tutorials/fakedata.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Making a Mock Dataset</p>
      </div>
    </a>
    <a class="right-next"
       href="../changelog.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Changelog</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mpol-and-models">MPoL and models</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#non-parametric-models">Non-parametric models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parametric-models">Parametric models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dsharp-as-209-dataset">DSHARP AS 209 dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction-to-probabilistic-programming-languages">Introduction to Probabilistic Programming Languages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-parametric-disk-model">Building a parametric disk model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prior-predictive-check">Prior predictive check</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#incorporating-the-data">Incorporating the data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference-with-stochastic-variational-inference-svi">Parameter inference with Stochastic Variational Inference (SVI)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-of-samples">Visualization of samples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#svi-with-a-automultivariatenormal-model">SVI with a AutoMultivariateNormal Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Visualization of samples</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameter-inference-with-mcmc">Parameter inference with MCMC</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Ian Czekala
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2019-22, Ian Czekala.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>